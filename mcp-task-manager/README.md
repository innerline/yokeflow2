# MCP Task Manager

A Model Context Protocol (MCP) server for managing hierarchical task tracking in autonomous coding projects.

**Version**: 2.1.0

## Overview

This MCP server provides structured task management capabilities through a **PostgreSQL database**, enabling agents to:
- Query project progress and next tasks
- Create and expand epics into tasks
- Update task completion status
- Track test results with error details, execution time, and retry counts ⭐ NEW v2.1
- Trigger automated epic re-testing for regression detection ⭐ NEW v2.1
- Query stability metrics and analytics ⭐ NEW v2.1
- Log session history

**Architecture:** TypeScript MCP server with `pg` (node-postgres) for database operations and connection pooling.

**Status:** Production-ready (v2.1.0, February 2026)

## What's New in v2.1

**Test Execution Tracking** (Phase 1-2):
- Enhanced test result recording with error messages
- Execution time tracking for performance analysis
- Automatic retry count incrementation
- Performance indexes for detecting slow/flaky tests

**Epic Re-testing** (Phase 5):
- Smart epic selection (foundation, high-dependency, standard)
- Automatic regression detection
- Stability scoring (0.00-1.00 scale)
- 3 new MCP tools for re-testing workflow

**Total Tool Count**: 15 tools (v2.0) → 20+ tools (v2.1)

## Features

### 20+ MCP Tools for Task Management

**Query Tools** (read-only):
- `task_status` - Overall project progress statistics
- `get_next_task` - Next highest priority task to work on
- `list_epics` - All epics (with optional `needs_expansion` filter)
- `get_epic` - Specific epic details with all tasks
- `list_tasks` - Tasks with filtering (by epic, status, etc.)
- `get_task` - Task details including all tests
- `list_tests` - All tests for a specific task
- `get_session_history` - Recent work session log
- `get_epic_stability_metrics` - Stability scores and re-test analytics ⭐ NEW v2.1

**Mutation Tools** (write operations):
- `create_epic` - Create new high-level feature area
- `create_task` - Create task within an epic
- `create_test` - Add test case to a task
- `update_task_status` - Mark task complete/incomplete
- `start_task` - Mark task as started (tracks timing)
- `update_test_result` - Mark test as pass/fail (legacy)
- `update_task_test_result` - Mark task test pass/fail with error details ⭐ NEW v2.1
- `update_epic_test_result` - Mark epic test pass/fail with error details ⭐ NEW v2.1
- `expand_epic` - Break epic into multiple tasks (bulk create)
- `log_session` - Log session completion with metadata

**Quality System Tools** ⭐ NEW v2.1:
- `trigger_epic_retest` - Trigger smart epic re-testing (Phase 5)
- `record_epic_retest_result` - Record re-test with regression detection (Phase 5)

**All tools are project-scoped** - Operations automatically filtered by `PROJECT_ID` environment variable.

## Installation

### Prerequisites
- Node.js 18+ (for TypeScript compilation)
- PostgreSQL 14+ (running via Docker or locally)

### Build Steps

```bash
# 1. Install dependencies
cd mcp-task-manager
npm install

# 2. Build TypeScript → JavaScript
npm run build

# Verify compiled output exists
ls -la dist/index.js
```

### Database Setup

```bash
# 1. Start PostgreSQL via Docker
cd ..
docker-compose up -d

# 2. Initialize database schema
psql $DATABASE_URL -f schema/postgresql/001_initial_schema.sql

# 3. Verify tables exist
psql $DATABASE_URL -c "\dt"
```

## Configuration

The MCP server is automatically configured by `client.py` when sessions start. It receives two critical environment variables:

```bash
DATABASE_URL="postgresql://user:pass@host:5432/yokeflow"
PROJECT_ID="550e8400-e29b-41d4-a716-446655440000"
```

**How it works:**
1. Agent session starts via `orchestrator.py`
2. `client.py` loads MCP server configuration
3. Environment variables passed to MCP server process
4. All database queries automatically scoped to `PROJECT_ID`

**Example MCP Server Config** (auto-generated by `client.py`):
```json
{
  "mcpServers": {
    "task-manager": {
      "type": "stdio",
      "command": "node",
      "args": ["./mcp-task-manager/dist/index.js"],
      "env": {
        "DATABASE_URL": "postgresql://...",
        "PROJECT_ID": "550e8400-..."
      }
    }
  }
}
```

**Important:** You don't need to manually configure this - it's automatic. Just ensure:
- ✅ `dist/index.js` exists (run `npm run build`)
- ✅ PostgreSQL is running
- ✅ `DATABASE_URL` environment variable is set

## Usage in Agent Prompts

When writing agent prompts (e.g., `prompts/coding_prompt.md`), reference MCP tools with the `mcp__task-manager__` prefix:

### Example: Initialization Prompt
```markdown
## Your Task: Create Project Roadmap

1. Use `mcp__task-manager__create_epic` to create 15-25 high-level epics
2. Use `mcp__task-manager__expand_epic` to break each epic into 8-15 tasks
3. Use `mcp__task-manager__create_test` to add 1-3 tests per task
4. Use `mcp__task-manager__task_status` to verify completeness
```

### Example: Coding Prompt
```markdown
## Your Workflow

**Start Session:**
1. `mcp__task-manager__get_next_task` - Get your assignment
2. `mcp__task-manager__start_task` - Mark as started

**During Implementation:**
3. Implement the feature
4. Run tests with browser automation
5. `mcp__task-manager__update_test_result` - Mark each test pass/fail

**Complete Session:**
6. `mcp__task-manager__update_task_status` - Mark task complete (if all tests pass)
7. Commit to git
8. `mcp__task-manager__log_session` - Log session completion
```

### Tool Call Format
```typescript
// In agent prompt, tools are called like:
mcp__task-manager__get_next_task()

// Returns:
{
  "task_id": 42,
  "description": "Implement user authentication",
  "epic_name": "Core Security",
  "tests": [
    { "test_id": 101, "description": "Login with valid credentials" },
    { "test_id": 102, "description": "Reject invalid passwords" }
  ]
}
```

## Database Schema

The MCP server interacts with the following PostgreSQL tables:

**Core Tables:**
- `projects` - Project definitions (UUID primary keys, JSONB metadata)
- `epics` - High-level feature areas (15-25 per project)
- `tasks` - Individual coding tasks within epics (8-15 per epic)
- `tests` - Test cases for each task (1-3 per task)

**Tracking Tables:**
- `sessions` - Work session history (type: initializer/coding/review)
- `reviews` - Session quality reviews
- `github_commits` - Git commit tracking

**Views:**
- `v_progress` - Aggregate statistics (completion percentages)
- `v_next_task` - Next task to work on (ordered by priority)
- `v_epic_progress` - Per-epic completion rates

**Key Features:**
- All queries automatically scoped by `PROJECT_ID`
- Connection pooling for concurrent operations
- JSONB columns for flexible metadata
- Cascade deletes (deleting project removes all related data)

## Development

### Running in Development Mode
```bash
# Watch mode (auto-rebuild on changes)
npm run dev

# Or build once and run
npm run build
node dist/index.js
```

### Testing the MCP Server

**1. Direct Testing (stdio mode):**
```bash
# Build first
npm run build

# Test tool call via stdin/stdout
echo '{"jsonrpc": "2.0", "method": "tools/call", "params": {"name": "task_status"}, "id": 1}' | \
  DATABASE_URL="postgresql://..." PROJECT_ID="uuid..." node dist/index.js
```

**2. Via Python Tests:**
```bash
# From project root
python tests/test_mcp.py           # Full integration tests
python tests/test_mcp_direct.py    # Direct MCP server tests
```

**3. Via Web UI Sessions:**
```bash
# Start API server and create project via Web UI
uvicorn api.main:app --host 0.0.0.0 --port 8000
# Then use Web UI at http://localhost:3000 to start sessions
# Observe MCP tool calls in API server logs
```

### Debugging

**Enable verbose logging:**
```bash
# Set debug environment variable
DEBUG=mcp:* node dist/index.js
```

**Test database queries directly:**
```bash
# Check progress for a project
psql $DATABASE_URL -c "
  SELECT * FROM v_progress
  WHERE project_id = '550e8400-e29b-41d4-a716-446655440000';
"

# Get next task
psql $DATABASE_URL -c "
  SELECT * FROM v_next_task
  WHERE project_id = '550e8400-e29b-41d4-a716-446655440000'
  LIMIT 1;
"
```

**Common Issues:**
- **"MCP server failed to connect"** → Rebuild: `npm run build`
- **"Database connection error"** → Check `DATABASE_URL` is set
- **"No tasks found"** → Verify `PROJECT_ID` matches database
- **"Permission denied"** → Check PostgreSQL user permissions

## Architecture

```
┌─────────────────────────────────────┐
│  Agent (Claude via Python)         │
│  - Runs prompts/coding_prompt.md   │
│  - Calls MCP tools via SDK         │
└──────────────┬──────────────────────┘
               │ MCP Protocol (stdio)
┌──────────────▼──────────────────────┐
│  MCP Task Manager (Node.js)        │
│  - TypeScript + MCP SDK            │
│  - Receives tool calls             │
│  - Parses parameters               │
└──────────────┬──────────────────────┘
               │ SQL Queries
┌──────────────▼──────────────────────┐
│  PostgreSQL Database               │
│  - Connection pooling (pg lib)     │
│  - Project-scoped queries          │
│  - Views for common queries        │
└────────────────────────────────────┘
```

**Key Technologies:**
- **TypeScript** - Type safety for tool definitions
- **@modelcontextprotocol/sdk** - MCP protocol implementation
- **pg (node-postgres)** - Database driver with connection pooling
- **stdio transport** - Process-based communication
- **Async/await** - Non-blocking database operations

**Benefits over Shell Scripts:**
- ✅ Type-safe tool definitions (compile-time checks)
- ✅ Better error handling (structured error messages)
- ✅ No shell injection risks (direct parameter passing)
- ✅ Real-time capable (foundation for WebSocket updates)
- ✅ Extensible (add new tools in 5 lines)
- ✅ Language-agnostic (protocol-based, not bash-specific)

## Migration History

### Before (Shell Script Era)
```bash
# Old approach: task-helper.sh
./task-helper.sh status
./task-helper.sh next
./task-helper.sh complete 42
```

**Problems:**
- Shell escaping issues
- No type safety
- Hard to extend
- Limited error handling

### After (MCP Server)
```python
# New approach: MCP tools
mcp__task-manager__task_status()
mcp__task-manager__get_next_task()
mcp__task-manager__update_task_status(task_id=42, completed=True)
```

**Migration Mapping:**

| Old Shell Command | New MCP Tool |
|-------------------|--------------|
| `task-helper.sh status` | `task_status` |
| `task-helper.sh next` | `get_next_task` |
| `task-helper.sh complete <id>` | `update_task_status` |
| `task-helper.sh pass-test <id>` | `update_test_result` |
| `task-helper.sh expand-epic` | `expand_epic` |

✅ **Migration Complete:** Shell script deleted, MCP-only mode (December 2025)

## Version History

**v2.1.0** (February 2026)
- ✅ Test execution tracking (error messages, execution time, retry counts)
- ✅ Epic re-testing system (3 new tools)
- ✅ Stability scoring and analytics
- ✅ Automatic regression detection
- ✅ Performance indexes for test analysis
- ✅ 20+ MCP tools total

**v2.0.0** (December 2025)
- ✅ PostgreSQL migration complete
- ✅ Async operations with connection pooling
- ✅ UUID-based project identification
- ✅ JSONB metadata support
- ✅ Multi-project support
- ✅ Production-ready architecture
- ✅ 15 MCP tools

**v1.0.0** (Initial Release)
- MCP protocol implementation
- SQLite support (legacy, removed)
- Basic task management tools

## Future Enhancements

**Planned:**
- Task dependencies and critical path analysis
- Time tracking and duration estimates
- Multi-agent collaboration (task assignment)
- Enhanced review integration (auto-trigger reviews)

**Under Consideration:**
- GraphQL interface for complex queries
- Real-time subscriptions via WebSocket
- Task templates and reusable patterns
- AI-assisted task breakdown

## Related Documentation

### MCP Documentation
- [docs/mcp-usage.md](../docs/mcp-usage.md) - MCP usage guide for developers
- [MCP Protocol Specification](https://spec.modelcontextprotocol.io/) - Official MCP docs

### Quality System (v2.1)
- [QUALITY_SYSTEM_SUMMARY.md](../QUALITY_SYSTEM_SUMMARY.md) - Phase-by-phase implementation summary
- [docs/quality-system.md](../docs/quality-system.md) - Complete quality system documentation
- [docs/configuration.md](../docs/configuration.md) - Epic testing and re-testing configuration

### Platform Documentation
- [README.md](../README.md) - Platform overview
- [CLAUDE.md](../CLAUDE.md) - Quick reference guide
- [docs/developer-guide.md](../docs/developer-guide.md) - Platform architecture
- [docs/api-usage.md](../docs/api-usage.md) - REST API reference (60+ endpoints)

### Database
- [schema/postgresql/schema.sql](../schema/postgresql/schema.sql) - Complete database schema
- [docs/postgres-setup.md](../docs/postgres-setup.md) - PostgreSQL setup guide
